---
title: "Lesson 4: Going further with mixed models"
author: "Quentin D. Read"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = TRUE, warning = TRUE)
```

# Learning objectives

At the end of this lesson, students will ...

- Fit a linear mixed model with crossed and nested random effects.
- Fit a linear mixed model with a transformed response variable.
- Fit a generalized linear mixed model to binary outcome data.
- Fit a generalized linear mixed model to count outcome data.

# Crossed and nested random effects

For this next example, we are finally going to use some real data! We're going to use a dataset with results from a study of Precision Zonal Management (PZM) conservation agriculture practices (data hosted on [Ag Data Commons](https://data.nal.usda.gov/dataset/regionally-adapted-implementation-conservation-agriculture-delivers-rapid-improvements-soil-properties-associated-crop-yield-stability)). In this study, the experimental treatments were two different tillage systems crossed with presence or absence of rye cover crop. The original dataset contains results for both maize and soybean yields but I am giving you only the maize yield data for simplicity.

```{r}
library(tidyverse)
library(lmerTest)

maize <- read_csv('../datasets/pzm_maize.csv')
```

Take a look at the data frame.

```{r}
glimpse(maize)
```

There are multiple locations and multiple years. The locations are identified by state. The `plot` and `block` column have integers identifying the plots and blocks. The `tillage` column has two different values, `"cp"` (chisel plow) and `"rt"` (ridge tillage). The `cover.trt` column also has two different values, `"none"` and `"rye"`.

We need to convert the `yr`, `plot`, and `block` columns to factor type because they are integers and we want to treat them as categorical for the model. We will use `mutate()` to do this.

```{r}
maize <- maize %>%
  mutate(
    yr = factor(yr),
    plot = factor(plot),
    block = factor(block)
  )
```

Make boxplots of the yield data using `geom_boxplot()`. Tillage treatment is on the *x* axis, cover treatment is distinguished by color of the boxes, and yield is on the *y* axis. We use `facet_grid()` to make a separate plot for each combination of location and year.

```{r}
ggplot(maize, aes(y = yield, x = tillage, fill = cover.trt)) +
  facet_grid(location ~ yr) +
  geom_boxplot(position = position_dodge()) +
  theme_bw()
```

This is a fairly complicated situation that is typical of multi-location multi-year trials. There are some location-year combinations in which the tillage treatments seem to result in different yields, and mostly minimal differences between the cover treatments. However the majority of the variation is between locations and years.

How do we set up this model? Well, we definitely want to have a fixed effect for tillage treatment, and another for cover treatment, and the interaction between the two. So our starting point is:

`yield ~ tillage + cover.trt + tillage:cover.trt`

The next question is, should location and year be random or fixed? This depends on the statistical inference we want to draw. If we are interested in change over time, year should be a fixed effect. But if we think of the years the study was conducted as a "random sample" of the potential years we could have used, and we are not interested in comparing means of the different years, year should be a random effect. The same goes for location. For the sake of this example, let's say year and location will both be random effects. We will fit them as *crossed* random effects, meaning an intercept will be fit for each year and each location. This means we assume the effect of year is constant across locations, and vice versa. So now we have

`yield ~ tillage + cover.trt + tillage:cover.trt + (1 | yr) + (1 | location)`

Notice I did not include random slopes, only random intercepts. It could potentially also make sense to include random slopes, if we think the treatment effect is different by location and year, not just that the locations and years have different "baseline" yields.

We also have many blocks at a given location, each of which has many plots. Block should definitely be treated as a random effect *nested* within location. Block 1 in Illinois is not the same as Block 1 in Minnesota; it would make no sense to have We do not need to include plot explicitly, because the plots are individual data points. The random variation of plots is already taken care of by the overall model residuals. This will add one more random intercept term to our model. We use the `:` operator to separate nesting terms.

`yield ~ tillage + cover.trt + tillage:cover.trt + (1 | yr) + (1 | location) + (1 | block:location)`

Here is the model.

```{r}
fit_maize <- lmer(yield ~ tillage + cover.trt + tillage:cover.trt + (1 | yr) + (1 | location) + (1 | block:location), data = maize)
```

An alternative here would be to give each location-year combination its own intercept. This would mean that location is *nested* within year as well, resulting in three levels of nesting, year : location : block. That might make sense in this case if the locations are far enough apart that we do not think the random variation of years would be consistent across locations. The formula would look like this:

`yield ~ tillage + cover.trt + tillage:cover.trt + (1 | location:yr) + (1 | block:location:yr)`

If we wanted to do random slopes in this model, we would have to specify which terms would be random and which grouping factors would get separate slopes fitted to them. For example, we might want to fit only random slopes for the main effect terms, and only for the year-location combination. The formula would look like this:

`yield ~ tillage + cover.trt + tillage:cover.trt + (tillage + cover.trt | location:yr) + (1 | block:location:yr)`

These examples demonstrate how many modeling decisions have to be made for even a relatively clean and neat dataset.

# Non-normal 

# Load some sample data

We are going to use some data from the **agridat** package, which has lots of example datasets from agricultural science. You can either load the example data from the package directly using `data()`, or read it in from a CSV in the `datasets` folder. Here are both ways of doing it.

```{r}
library(tidyverse)
library(lmerTest)

```


# Generalized linear mixed models

Taking the log transformation of the response variable before fitting the model is a good solution for many types of data. However it won't always work. INSERT MORE TEXT HERE

- Count data (Poisson GLMM)
- Binary outcome data (Logistic GLMM)

- Show how the residuals cannot be normally distributed for these data
- Discuss log link for Poisson, logit or log odds link for logistic regression

- Show an example of each

- We can set up the model with all the same kinds of fixed and random effects as in plain vanilla linear mixed models. For example, we can have continuous and categorical predictors, interactions, crossed or nested random effects, random intercepts and/or random slopes.

# Hey! What about ...

- These are only a little bit of what you can do. I don't have time to cover all GLMM types in this workshop.
- glmer() doesn't have all the possibilities
- Other common ones are beta-regression, where the response variable is a probability or proportion bounded between 0 and 1
- Cumulative logistic mixed model is another common case, where the response variable is a categorical outcome with more than two possibilities
  + For example a choice trial where insects are released into an olfactometer and may go down one of four arms where different odor attractants are found.
  
- The Bayesian modeling packages **brms** and **rstanarm** are also great alternatives that I would recommend looking into. I'm going to do a workshop on **brms** soon.

# Hey! What about ...

- Repeated measures designs
- Spatial autocorrelation
- Overdispersion in count data
- Different types of random effects (G-side versus R-side) and error structures

These are "advanced topics" in mixed modeling. They are out of scope for this workshop. 